<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Make the snowflake!</title>
    <link rel="manifest" href="manifest.json"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#191970">
    <link rel="icon" href="files/icon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <script src="js/aframe.js"></script>
    <script src="js/player.js"></script>
    <script src="js/history.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
<div class="wrapper">
    <canvas id="main_canvas"></canvas>
    <canvas id="dot_canvas"></canvas>
    <div class="cover left"></div>
    <div class="cover right"></div>
</div>
<div class="btns">
    <div class="preview">
        <p>PREVIEW</p>
        <p>EDIT</p>
    </div>
    <div class="start">
        <p>Let it snow</p>
        <p>Stop</p>
    </div>
    <div class="save">
        <p>   SAVE   </p>
    </div>
   <div class="history">
     <p class="prev"><span class="glyphicon glyphicon-chevron-left"></span></p>
     <p class="next"><span class="glyphicon glyphicon-chevron-right"></span></p>
   </div>
    <div class="refill">
        <p>Reset</p>
        <span class="glyphicon glyphicon-repeat">
    </div>
</div>
<a-scene vr-mode-ui="enabled: true" inspector="url: https://aframe.io/releases/0.8.0/aframe-inspector.min.js"
         fog="type: linear; color: #191970;near:1;far:100">
    <a-assets>
        <a-asset-item id="snowflake" src="files/plate_mirror.obj"></a-asset-item>
        <img src="flake2.png" id="flake_tile">
    </a-assets>
    <a-sky color="#000"></a-sky>
    <a-light type="ambient" color="#444"></a-light>
    <a-light type="point" color="#eee" position="0 0 0"></a-light>
    <a-entity class="container" position="0 0 0" rotation="0 0 0">
        <a-entity static-body class="sample" obj-model="obj: #snowflake;" scale=".2 .2 .2" position="0 0.3 -5"
                  rotation="45 0 0" material="color:white;transparent:true;side:double">
            <a-animation easing="linear" attribute="rotation" dur="10000" fill="forwards" to="45 360 0"
                         repeat="indefinite"></a-animation>
        </a-entity>
        <a-entity id="cam" camera position="0 0 0" rotation="0 0 0">
        </a-entity>
    </a-entity>
</a-scene>
<div id="slideout">
  <!--img src="player.png" alt="Audio" /-->
	  <div id="slideout_inner">
<div class="player">
    <div class="controls">
        <div class="play_pause">
            <div class="play_pause_icon play_pause-play"></div>
        </div>
        <div class="navigation">
            <div class="navigation_prev">
                <div class="navigation_prev_icon"></div>
            </div>
            <div class="navigation_next">
                <div class="navigation_next_icon"></div>
            </div>
        </div>
        <div class="progress_bar">
            <div class="progress_bar_title">---</div>
            <div class="progress_bar_stripe">
                <div class="progress_bar_container">
                    <div class="progress_bar_container_percentage"></div>
                </div>
            </div>
        </div>
    </div>
</div>
	  </div>
	</div>
</body>
<script>
    let tile_context;
    let dot_context;
    let st_x;
    let st_y;
    let rand_interval;
    let player = new Player(FILES);
    let operations = new OperationsHistory();

    function make_one() {
        let ini_x = (Math.random() * 100 - 50);
        let ini_y = (Math.random() * 100 + 100);
        let ini_z = (Math.random() * 100 - 50);
        let t_txt = '<a-entity class="snow" position="' + ini_x + ' ' + ini_y + ' ' + ini_z + '" rotation="0 0 0" obj-model="obj: #snowflake;" scale=".2 .2 .2" material="side:double;transparent:true;src:#flake_tile"><a-animation attribute="position" easing="linear" dur="' + (Math.random() * 20000 + 15000) + '" fill="forwards" to="' + ini_x + ' ' + (Math.random() * 40 - 200) + ' ' + ini_z + '"></a-animation><a-animation attribute="rotation" easing="linear" dur="' + (Math.random() * 20000 + 15000) + '" fill="forwards" to="' + (Math.random() * 30) + ' ' + (Math.random() * 360) + ' 0"></a-animation></a-entity>';
        $(t_txt).appendTo($('a-scene'));
    }

    function maintain() {
        const num_snowflakes = 120;
        if ($('a-entity.snow').length < num_snowflakes) {
            make_one();
        } else if ($('a-entity.snow').eq(0).attr('position').y < -100) {
            $('a-entity.snow').eq(0).remove();
        }
    }

    function snow() {
        rand_interval = setInterval(function () {
            maintain();
        }, 300);
    }

    $('.start').on('click', function () {
        if ($('body').hasClass('snowing')) {
            clearInterval(rand_interval);
            $('a-entity.snow').remove();
            $('body').removeClass('snowing');
            let t_txt = '<a-entity class="sample" obj-model="obj: #snowflake;" scale=".2 .2 .2" position="0 0.3 -5" rotation="45 0 0" material="src:#flake_tile;transparent:true;side:double"><a-animation easing="linear" attribute="rotation" dur="10000" fill="forwards" to="45 360 0" repeat="indefinite"></a-animation></a-entity>';
            $(t_txt).appendTo($('.container'));
            $('#cam').removeAttr('look-controls');
            $('#cam').attr('rotation', '0 0 0');
            scene = document.querySelector('a-scene');
            scene.exitVR();
            player.pause();
            getByQuery(".player").style.visibility = "hidden";
        } else {
            $('body').addClass('snowing');
            getByQuery(".player").style.visibility = "visible";
            player.play();
            let dataUrl = tile.toDataURL()
            apply_img(dataUrl);
            snow();
            $('.sample').remove();
            $('#cam').attr('look-controls', '')
        }
    })


    let is_drawing = 0;
    let timeoutId;
    $('.wrapper').on('click', function (e) {
       if (!timeoutId)
		timeoutId = setTimeout('clearTimeout(timeoutId);', 500);
        let t_x = e.pageX - $('#main_canvas').offset().left;
        let t_y = e.pageY - $('#main_canvas').offset().top;
        let o_x = e.pageX - $(this).offset().left
        let o_y = e.pageY - $(this).offset().top

        if (is_drawing == 0) {
            let dataUrl = tile.toDataURL()
            operations.push(dataUrl.toString());
            st_x = e.pageX
            st_y = e.pageY
            tile_context.globalCompositeOperation = 'destination-out'
            dot_context.globalCompositeOperation = 'source-over'
            tile_context.beginPath()
            dot_context.beginPath()
            tile_context.moveTo(t_x, t_y)
            dot_context.moveTo(o_x, o_y)
            is_drawing = 1
            $('<div class="first dot" style="left:' + o_x + 'px;top:' + o_y + 'px;"></div>').appendTo($(this))
        } else if (is_drawing > 0) {
            let dist = Math.sqrt((e.pageX - st_x) * (e.pageX - st_x) + (e.pageY - st_y) * (e.pageY - st_y))
            if (dist < 15) {
                tile_context.closePath()
                tile_context.fill()
                dot_context.closePath()
                dot_context.clearRect(0, 0, $('#dot_canvas').width(), $('#dot_canvas').height())
                is_drawing = 0;
                $('.dot').remove()
                let dataUrl = tile.toDataURL()
                apply_img(dataUrl);
            } else {
                tile_context.lineTo(t_x, t_y)
                dot_context.lineTo(o_x, o_y)
                dot_context.stroke()
                is_drawing++
                $('<div class="dot" style="left:' + o_x + 'px;top:' + o_y + 'px;"></div>').appendTo($(this))
            }

        }
    })
    $('.wrapper').on('mousemove', function (e) {
        let dist = Math.sqrt((e.pageX - st_x) * (e.pageX - st_x) + (e.pageY - st_y) * (e.pageY - st_y))
        if (dist < 15) {
            $('.first').addClass('on')
        } else {
            $('.first').removeClass('on')
        }
    })
    $('.wrapper').on('dblclick', function(e) {
     is_drawing = 0;
     clearTimeout(timeoutId);
     dot_context.clearRect(0, 0, $('#dot_canvas').width(), $('#dot_canvas').height())
     $('.dot').remove()
    })


    function apply_img(dataUrl) {
        $('a-assets > img').attr('src', dataUrl)
        $('.sample').remove();
        let t_txt = '<a-entity class="sample" obj-model="obj: #snowflake;" scale=".2 .2 .2" position="0 0.3 -5" rotation="45 0 0" material="src:#flake_tile;transparent:true;side:double"><a-animation easing="linear" attribute="rotation" dur="10000" fill="forwards" to="45 360 0" repeat="indefinite"></a-animation></a-entity>'
        $(t_txt).appendTo($('.container'))
    }

    $('.preview').on('click', function () {
        $('.wrapper').toggleClass('pre')
        $(this).toggleClass('pre')
        if ($('body').hasClass('sneak')) {
            $('body').removeClass('sneak')
        } else {
            $('body').addClass('sneak')
            let dataUrl = tile.toDataURL()
            apply_img(dataUrl)
        }
    })

    $('.next').on('click', function () {
      next = operations.getNext();
       var img = new Image();
      img.onload = function(){
      tile_context.globalCompositeOperation = 'source-over';
      tile_context.drawImage(img, 0, 0,  $('#main_canvas').width(), $('#main_canvas').height()); // Or at whatever offset you like
      };
      img.src = next;
      apply_img(next);
    });
    $('.prev').on('click', function () {
      previous = operations.getPrev();
      var img = new Image();
      img.onload = function(){
      tile_context.globalCompositeOperation = 'source-over';
      tile_context.drawImage(img, 0, 0,  $('#main_canvas').width(), $('#main_canvas').height()); // Or at whatever offset you like
      };
      img.src = previous;
      apply_img(previous);
    });

    function paper() {
        $('#main_canvas').attr('height', $('.wrapper').height() * 0.7 * 2)
        $('#main_canvas').attr('width', $('.wrapper').height() * 0.7 * 0.54838709677 * 2)
        $('#dot_canvas').attr('width', $('.wrapper').width() * 2)
        $('#dot_canvas').attr('height', $('.wrapper').height() * 2)
        tile = document.getElementById("main_canvas");
        tile.style.width = tile.width / 2 + 'px'
        tile.style.height = tile.height / 2 + 'px'
        tile.getContext('2d').scale(2, 2)
        tile_context = tile.getContext("2d")
        tile_context.fillStyle = "rgba(255,255,255,1)"
        tile_context.fillRect(0, 0, $('#main_canvas').width(), $('#main_canvas').height())
        $('.cover.right').css('top', ($('#main_canvas').offset().top - $('.wrapper').offset().top) + 'px')
        $('.cover.left').css('top', ($('#main_canvas').offset().top - $('.wrapper').offset().top) + 'px')
        $('.cover.right').css('left', (($('.wrapper').width() - $('#main_canvas').width()) / 2 + $('#main_canvas').width()) + 'px')
        $('.cover.left').css('right', (($('.wrapper').width() - $('#main_canvas').width()) / 2 + $('#main_canvas').width()) + 'px')
        dot = document.getElementById("dot_canvas");
        dot.style.width = dot.width / 2 + 'px'
        dot.style.height = dot.height / 2 + 'px'
        dot.getContext('2d').scale(2, 2)
        dot_context = dot.getContext("2d")
        dot_context.fillStyle = "rgba(255,0,0,1)"
        dot_context.strokeStyle = '#666'
        dot_context.setLineDash([2, 4])
        dot_context.lineWidth = 1
    }

    function get_image() {
      html2canvas($('.wrapper').get(0)).then(function(canvas) {
      let img = canvas.toDataURL()
      let link = document.createElement('a');
      link.href = img;
      link.download = 'snowflake.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
     });
    }

    $(document).ready(function () {
        paper()
        getByQuery(".player").style.visibility = "hidden";
    })

    $(window).resize(function () {
        paper()
    })
    $('.save').on('click', get_image)
    $('.refill').on('click', function () {
        if (confirm('Are you sure you want to reset?')) {
            tile_context.closePath()
            tile_context.globalCompositeOperation = 'source-over'
            tile_context.fillRect(0, 0, $('#main_canvas').width(), $('#main_canvas').height())
            dot_context.clearRect(0, 0, $('#dot_canvas').width(), $('#dot_canvas').height())
            dot_context.closePath()
            is_drawing = 0
            $('.dot').remove()
            let dataUrl = tile.toDataURL()
            apply_img(dataUrl)
        }

    })
   function initialize_player(){
            getByQuery('.player .controls .play_pause').addEventListener('click', player.play.bind(player));
            getByQuery('.player .controls .navigation_prev').addEventListener('click', player.playPrev.bind(player));
            getByQuery('.player .controls .navigation_next').addEventListener('click', player.playNext.bind(player));
            getByQuery('.player .controls .progress_bar_stripe').addEventListener('click', player.pickNewProgress.bind(player));
  }
  window.addEventListener('DOMContentLoaded', initialize_player);
</script>
</html>
